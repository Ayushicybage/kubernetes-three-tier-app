name: Deploy to Kubernetes

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Kubernetes Cluster
    runs-on: [self-hosted, Windows, X64]

    steps:
      - name: üßæ Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: ‚öôÔ∏è Set up Kubeconfig
        shell: powershell
        run: |
          Write-Host "Setting up kubeconfig..."
          if (-Not (Test-Path "$HOME\.kube")) {
            New-Item -ItemType Directory -Path "$HOME\.kube" | Out-Null
          }
          $base64 = "${{ secrets.KUBE_CONFIG_DATA }}"
          $bytes = [System.Convert]::FromBase64String($base64)
          [System.Text.Encoding]::UTF8.GetString($bytes) | Out-File "$HOME\.kube\config" -Encoding UTF8
          Write-Host "‚úÖ Kubeconfig written to $HOME\.kube\config"

      - name: üß± Ensure Kind cluster is running
        shell: powershell
        run: |
          Write-Host "Checking if Kind cluster exists..."
          $cluster = kind get clusters 2>$null
          if (-not $cluster) {
            Write-Host "No Kind cluster found. Creating one..."
            kind create cluster --name three-tier
          } else {
            Write-Host "Kind cluster already exists. Checking if nodes are ready..."
            try {
              $nodes = kubectl get nodes 2>$null
              if (-not $nodes) {
                Write-Host "Cluster found but not reachable ‚Äî restarting container..."
                kind delete cluster --name three-tier
                kind create cluster --name three-tier
              } else {
                Write-Host "Kind cluster is active and reachable."
              }
            } catch {
              Write-Host "Cluster unreachable ‚Äî recreating..."
              kind delete cluster --name three-tier
              kind create cluster --name three-tier
            }
          }

      - name: üîç Verify cluster connection
        shell: powershell
        run: |
          Write-Host "Verifying Kubernetes cluster connection..."
          kubectl get nodes

      - name: üßπ Clean existing MySQL PVC (Safe JSON Patch)
        shell: powershell
        run: |
          Write-Host "Checking and cleaning existing MySQL PVC..."
          $pvcName = "mysql-storage-mysql-0"
          $namespace = "three-tier"
      
          # Check if PVC exists
          $pvcExists = kubectl get pvc $pvcName -n $namespace --ignore-not-found
          if (-not $pvcExists) {
            Write-Host "No existing PVC found. Skipping cleanup."
            exit 0
          }
      
          Write-Host "PVC found. Attempting to remove finalizers (if stuck)..."
      
          # ‚úÖ Create JSON patch file (avoids quoting issues)
          $patchDir = "C:\Temp"
          if (!(Test-Path $patchDir)) { New-Item -ItemType Directory -Path $patchDir | Out-Null }
          $patchFile = Join-Path $patchDir "pvc_patch.json"
          Set-Content -Path $patchFile -Value '{"metadata":{"finalizers":[]}}'
      
          kubectl patch pvc $pvcName -n $namespace --type merge --patch-file $patchFile 2>$null
      
          Write-Host "Forcing PVC deletion (non-blocking)..."
          kubectl delete pvc $pvcName -n $namespace --ignore-not-found --grace-period=0 --force --wait=false
      
          Write-Host "PVC cleanup step complete."

      - name: ‚è≥ Wait for PVC to terminate completely
        shell: powershell
        run: |
          Write-Host "Waiting for old MySQL PVC to fully terminate..."
          $pvcName = "mysql-storage-mysql-0"
          $namespace = "three-tier"
          $timeout = 60
          $elapsed = 0
          while ($elapsed -lt $timeout) {
            $exists = kubectl get pvc $pvcName -n $namespace --ignore-not-found
            if (-not $exists) {
              Write-Host "‚úÖ PVC $pvcName has been deleted."
              break
            }
            Write-Host "PVC still terminating... waiting 5 seconds..."
            Start-Sleep -Seconds 5
            $elapsed += 5
          }

      - name: üöÄ Apply Kubernetes manifests
        shell: powershell
        run: |
          Write-Host "Applying all YAML manifests from ./Application-k8s ..."
          Get-ChildItem -Path "./Application-k8s/" -Filter *.yaml -Recurse |
          Where-Object { $_.FullName -notmatch "\\.github\\" } |
          ForEach-Object {
            Write-Host "Applying $($_.Name)..."
            kubectl apply -f $_.FullName -n three-tier --validate=false
          }

      - name: ‚úÖ Verify deployment status
        shell: powershell
        run: |
          Write-Host "Listing pods and services in 'three-tier' namespace..."
          kubectl get pods -n three-tier
          kubectl get svc -n three-tier
