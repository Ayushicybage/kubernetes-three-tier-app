name: Deploy to Kubernetes

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Kubernetes connection
        shell: pwsh
        env:
          KUBECONFIG: "C:\\Users\\ayushidh\\.kube\\config"
        run: |
          Write-Host "âœ… Verifying Kubernetes connection..."
          kubectl config current-context
          kubectl get nodes
        continue-on-error: false

      - name: Deploy to cluster
        shell: pwsh
        env:
          KUBECONFIG: "C:\\Users\\ayushidh\\.kube\\config"
        run: |
          Write-Host "ðŸš€ Deploying Kubernetes manifests"
          kubectl apply -f ./Application-k8s/ -n three-tier
          kubectl rollout status deployment/backend -n three-tier
          kubectl rollout status deployment/frontend -n three-tier
          kubectl get pods -n three-tier

      - name: Verify deployment resources
        shell: pwsh
        env:
          KUBECONFIG: "C:\\Users\\ayushidh\\.kube\\config"
        run: |
          Write-Host "ðŸ“¦ Listing all resources in 'three-tier' namespace..."
          kubectl get all -n three-tier
