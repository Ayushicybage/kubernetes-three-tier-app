name: Deploy to Kubernetes

on:
  push:
    branches: [ "main" ]

defaults:
  run:
    shell: pwsh   # ðŸ‘ˆ Ensures PowerShell on Windows runner

jobs:
  deploy:
    name: Deploy to Kubernetes Cluster
    runs-on: [self-hosted, Windows, X64]   # ðŸ‘ˆ Must match labels from GitHub runner page

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Kubernetes connection
        env:
          KUBECONFIG: "C:\\Users\\ayushidh\\.kube\\config"
        run: |
          Write-Host "Using kubeconfig at $env:KUBECONFIG"
          type $env:KUBECONFIG
          kubectl config view
          kubectl config current-context
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy to cluster
        env:
          KUBECONFIG: "C:\\Users\\ayushidh\\.kube\\config"
        run: |
          Write-Host "ðŸš€ Deploying Kubernetes manifests..."
          kubectl apply -f "C:\\Users\\ayushidh\\Desktop\\Application-k8s\\" -n three-tier
          kubectl rollout status deployment/backend -n three-tier
          kubectl rollout status deployment/frontend -n three-tier
          kubectl get pods -n three-tier

      - name: Verify deployment resources
        env:
          KUBECONFIG: "C:\\Users\\ayushidh\\.kube\\config"
        run: |
          Write-Host "ðŸ“¦ Listing all resources in 'three-tier' namespace..."
          kubectl get all -n three-tier
