name: Deploy to Kubernetes

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # ðŸ‘ˆ Allows manual trigger from GitHub UI

defaults:
  run:
    shell: pwsh  # Use PowerShell on Windows runner

jobs:
  deploy:
    name: Deploy to Kubernetes Cluster
    runs-on: [self-hosted, Windows, X64]

    env:
      KUBECONFIG: "C:\\Users\\ayushidh\\.kube\\config"
      NAMESPACE: "three-tier"

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: Debug Runner Info
        run: |
          Write-Host "Running on OS: $env:OS"
          hostname
          whoami
          $PSVersionTable  

      - name: ðŸ” Verify Kubernetes connection
        run: |
          Write-Host "âœ… Using kubeconfig at $env:KUBECONFIG"
          kubectl config view
          kubectl config current-context
          kubectl cluster-info
          kubectl get nodes

      - name: ðŸš€ Deploy to cluster
        run: |
          Write-Host "Applying manifests from $env:GITHUB_WORKSPACE ..."
          kubectl apply -f "$env:GITHUB_WORKSPACE" -n $env:NAMESPACE
          if ($LASTEXITCODE -ne 0) { Write-Error "kubectl apply failed!"; exit 1 }

          Write-Host "Waiting for backend rollout..."
          kubectl rollout status deployment/backend -n $env:NAMESPACE --timeout=120s
          if ($LASTEXITCODE -ne 0) { Write-Error "Backend deployment failed!"; exit 1 }

          Write-Host "Waiting for frontend rollout..."
          kubectl rollout status deployment/frontend -n $env:NAMESPACE --timeout=120s
          if ($LASTEXITCODE -ne 0) { Write-Error "Frontend deployment failed!"; exit 1 }

      - name: ðŸ“¦ Verify deployment resources
        run: |
          Write-Host "Listing all resources in '$env:NAMESPACE' namespace..."
          kubectl get all -n $env:NAMESPACE

      - name: ðŸ§© Capture logs if failure occurs
        if: failure()
        continue-on-error: true
        run: |
          Write-Host "Collecting logs for debugging..."
          kubectl get pods -n $env:NAMESPACE
          kubectl logs -l app=backend -n $env:NAMESPACE > backend.log
          kubectl logs -l app=frontend -n $env:NAMESPACE > frontend.log

      - name: ðŸ“¤ Upload logs as artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: k8s-logs
          path: "*.log"
